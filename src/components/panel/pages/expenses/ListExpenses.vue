<template>
    <div class="box">
        <nav class="breadcrumb">
            <li><a href="#">inicio</a></li>
            <li><a href="#" class="active">despesas</a></li>
        </nav>  

        <nav class="tabs">
            <button class="tabs__item tabs__item--active">Despesas</button>
            <!-- <button class="tabs__item">Produtos</button> -->
        </nav>

        <div class="tabs-container">
            <div class="box-but">

                <div class="box-but-left">
                    <router-link class="but primary" :to="{name: 'painel.despesas.adicionar'}">Adicionar</router-link> 
                </div>

                <div class="box-but-right">

                    <div class="but-group ma-r-small">
                        <button class="but prev" @click.prevent="prevMonth">
                            <svg class="feather white">
                                <use xlink:href="@/assets/svg/feather-sprite.svg#arrow-left"></use>
                            </svg>                
                        </button>
                        
                        <button class="but tertiary">{{ month | monthString }} - {{ year }}</button>
                        
                        <button class="but next" @click.prevent="nextMonth">
                            <svg class="feather white">
                                <use xlink:href="@/assets/svg/feather-sprite.svg#arrow-right"></use>
                            </svg>
                        </button>
                    </div>

                    <!-- COMPONENT DE PESQUISA -->
                    <search 
                        @search="searchForm"
                    >
                    </search>

                    <button class="but printer">
                        <svg class="feather">
                            <use xlink:href="@/assets/svg/feather-sprite.svg#printer"></use>
                        </svg>
                    </button>
                </div>
            </div>
            
            <table class="table-list">
                <thead>
                    <tr>
                        <th>Marcar</th>
                        <th>#numero</th>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Fornecedor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Valor</th>                        
                    </tr>
                </thead>

                <tbody>
                    <tr class="dotted" :class="{focused: focused === expense.id }" 
                        v-for="expense in expenses.data" :key="expense.id" 
                        @click.stop="focus(expense.id)" 
                        @dblclick="edit(expense.id)"
                    >
                        <td>
                             <label>
                                <input type="checkbox" class="field__checkbox" 
                                    @click.stop="select(expense.id, $event.target.checked)" 
                                    :checked="selected.includes(expense.id)"
                                >
                            </label>
                        </td>
                        <td>{{ expense.numero }}</td>
                        <td>22/06/2019</td>
                        <td>Serviços de reparo em caminhão Ford 2010 </td>
                        <td>JR AUTO PEÇAS </td>
                        <td> 30/06/2019   </td>
                        <td>-----</td>
                        <td>R$ {{ expense.valor }}</td>
                    </tr>
                </tbody>
            </table>

            
        </div>

        <paginate
                :pagination="expenses"
                :offset="6"
                @paginate="loadExpenses"
            >
            </paginate>

    </div>
</template>

<script>
    import PaginationGeneral from '../../../share/PaginationGeneral'
    import SearchPanel from '../../share/SearchPanel'

    export default {
        created () {
            this.loadExpenses(1)
        },

        data() {
            return {
                search: '',
                selected: [],
                focused: '',
                year: 2020,
                month: 8,
            }
        },

        filters: {
            monthString (value) {
                const months = {
                    1: 'Janeiro',
                    2: 'Fevereiro',
                    3: 'Março',
                    4: 'Abril',
                    5: 'Maio',
                    6: 'Junho',
                    7: 'Julho',
                    8: 'Agosto',
                    9: 'Setembro',
                    10: 'Outubro',
                    11: 'Novembro',
                    12: 'Dezembro'
                }
                return months[value]
            }
        },
        
        computed: {
            expenses(){
                return this.$store.state.expenses.items
            },

            params() {
                return {
                    page: this.expenses.current_page,
                    filter: this.search
                }
            }
        },

        methods: {
            loadExpenses(page){
                const ano = this.year
                const mes = this.month

                this.$store.dispatch('loadExpenses', {...this.params, page, ano, mes})
            },
            
            searchForm (filter) {
                this.search = filter,
                this.loadExpenses(1)
            },

            edit (id) {
                this.$store.dispatch('loadExpense', id)
                    .then(reponse => {
                        this.$router.push({ name: 'painel.despesas.visualizar', params: {id: id}})
                    })
                    .catch(error => {
                        this.$snotify.error('Algo errado ao visualizar', 'Erro')
                    })
            },

            select(id, checked) {
                if(checked){
                    this.selected.push(id)
                    return
                }
                const index = this.selected.findIndex( (element) => id === element )
                //Early return tecnica
                if(index < 0 ){
                    return
                }
                this.selected.splice(index, 1)
            },

            selectAll($event) {
                if ($event.target.checked){
                        this.selected = this.expenses.data.map( (expense) => expense.id)
                     
                     return 
                }
                this.selected = []
            },

            focus (id){
                this.focused = id
            },
            
            onPress ($event){
                // console.log($event.keyCode)
                if(!this.focused){
                    
                    return
                }

                if($event.keyCode === 32){
                    this.select(this.focused, !this.selected.includes(this.focused) )

                    return
                }

                let index = this.expenses.data.findIndex( (element) => this.focused === element.id)
                
                if ($event.keyCode === 38) {
                    index--
                } else if ($event.keyCode === 40) {
                    index++
                }

                if(!this.expenses.data[index]){
                    
                    return
                }
                this.focused = this.expenses.data[index].id
            },

            prevMonth(){
                let month = this.month-1

                if(month <= 0){
                    month = 12
                    this.year = this.year -1
                }
                this.month = month
                this.loadExpenses(1)
            },

             nextMonth(){
                let month = this.month+1

                if(month >= 13){
                    month = 1
                    this.year = this.year +1
                }
                this.month = month
                this.loadExpenses(1)
            },
        },

        components: {
           paginate: PaginationGeneral, 
           search: SearchPanel
        },

        mounted() {
            document.addEventListener("keyup", this.onPress)
        },

        destroyed() {
            document.removeEventListener("keyup", this.onPress)
        }
        
    }
</script>